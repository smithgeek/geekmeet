<!doctype html>
<html style="height: 100%;">
    <head>
        <title>GeekMeet</title>
        <script type="text/javascript">
            function getParameterByName(name, url) {
                if (!url) url = window.location.href;
                name = name.replace(/[\[\]]/g, "\\$&");
                var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                    results = regex.exec(url);
                if (!results) return null;
                if (!results[2]) return '';
                return decodeURIComponent(results[2].replace(/\+/g, " "));
            }
        </script>
    </head>
    <body style="margin: 0; padding: 0; height: 100%; overflow: hidden;">

        <div id="content" style="width: 100%; height: 100%; display: block">
            <iframe id="contentIframe" src="" style="height: 100%; width: 100%; border: 0px;"></iframe>
        </div>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io();
            const tv = getParameterByName('tv').replace(/ /g, "_");
            const room = getParameterByName("room").replace(/ /g, "_");
            const tvId = `${room}_${tv}`;
            let currentCount = 0;

            function handleParticipantCount(count){
                if(count > 0 && currentCount < 1){
                    document.querySelector('#contentIframe').src = `/meeting.html?room=${room}&tv=${tv}&isTv=true`;
                }
                if(count < 1 && currentCount > 0){
                    document.querySelector('#contentIframe').src = localStorage.getItem(tvId) || "";
                }
                currentCount = count;
            }
            document.querySelector('#contentIframe').src = localStorage.getItem(tvId) || "";
            socket.on("query", rooms => {
                socket.emit("join", {room, tv, isTv: true, url: localStorage.getItem(tvId)});
                rooms.forEach(r => {
                    if(r.name === room){
                        for(let i = 0; i < r.tvs.length; ++i){
                            if(r.tvs[i].name === tv){
                                handleParticipantCount(r.tvs[i].participants);
                            }
                        }
                    }
                });
            });
            socket.on("action", args => {
                console.log(args);
                if(args.action == "URL"){
                    localStorage.setItem(tvId, args.url);
                    document.querySelector("#contentIframe").src = args.url;
                    socket.emit("url_change", args.url);
                }
                else if(args.action === "RELOAD"){
                    window.location.reload();
                }
            });
            socket.on("participants_change", handleParticipantCount);
        </script>
    </body>
</html>